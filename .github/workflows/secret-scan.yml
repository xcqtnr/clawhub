name: "Security Gate: Secret Scanning"

on:
  pull_request:
    branches: [main, master]

jobs:
  trufflehog:
    name: Scan for Verified Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to scan the code in the PR
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # necessary to support the scoping requirements below

      - name: TruffleHog OSS
        id: trufflehog
        # Use a concrete released ref that resolves in upstream action registry.
        # v3 (major tag) is not published by trufflesecurity/trufflehog.
        uses: trufflesecurity/trufflehog@v3.93.6
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }} # scope it to the committed files
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified --debug

      - name: Notify on Failure
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "::error::Verified secrets found! This PR contains live credentials that must be rotated immediately."
          echo "::notice::If these secrets are already in the commit history, they cannot be removed via a simple removal commit/push. A repository owner can contact GitHub Support to purge the cached data: https://support.github.com/contact/private-information"
          exit 1
